---
title: "assignment_5_jj_ab"
author: "Jessica Jagdeo and Alex Brown"
date: "November 28, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}

library(tidyverse)
library(stargazer)
library(effsize)
library(knitr)
library(kableExtra)
library(plotly)
library(pwr)
library(car)
library(RColorBrewer)
library(extrafont)
library(ggrepel)
library(effsize)
library(ggpubr)
library(vcdExtra)
library(dplyr)

faculty_salary <- read_csv("faculty_salary_data.csv")

grad_enrollment <- read_csv("grad_enrollment_2.csv")

med_salary_doctoral <- read_csv("median_salary_doctoral.csv")

phds <- read_csv("phds_updated_2.csv")

phds_tbl2 <- read_csv("phds_updated_4.csv")
```

###1). Male and female graduate enrollment (1967 - 2015). Compare trends in total graduate enrollment for males and females (including full-time/part-time and private/public universities) in the United States from 1967 - 2015. Describe your results statistically, graphically and in text.

```{r, include=FALSE}
# Run a single regression model on graduate male graduate students from 1967-2015

male_grad_lm <- lm(grad_enrollment$total_males ~ grad_enrollment$year)

male_grad_lm

# Run Pearson's r

male_grad_pearson <- cor.test(grad_enrollment$year, grad_enrollment$total_males)

male_grad_pearson
# Run a single regression model on graduate female graduate students from 1967-2015.

female_grad_lm <- lm(grad_enrollment$total_females ~ grad_enrollment$year) 

female_grad_lm

female_grad_pearson <- cor.test(grad_enrollment$year, grad_enrollment$total_females)

female_grad_pearson


```

```{r, echo=FALSE}
# # Graph male and female enrollment together 

enroll_graph <- ggplot(grad_enrollment, aes(x = year, y = total_males)) +
  geom_line(aes(color = "total_males")) +
  geom_smooth(method = lm, se = F, aes(col = "Male Linear\n Regression\n")) +
  geom_smooth(aes(x = year, y = total_females, col = "Female Linear\n Regression\n"), method = lm, se = F) +
  geom_line(aes(x = year, y = total_females, color = "total_females")) +
  labs(x = "Year", y = "Total Enrollment") + 
  labs(color='Sex') +
  theme_classic() +
  scale_color_hue(labels = c("Female Linear\n Regression\n", "Male Linear\n Regression\n", "Total Females", "Total Males")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

enroll_graph
```

**Figure 1. Relationship between total female graduate enrolled students and year (1967-2015) and total male graduate enrolled students and year (1967-2015).** Year significantly predicts total female graduate enrollment (t(47) = 51.659, p < 0.001) with a strong positive correlation between the two variables (Pearson’s r = 0.99). Year also significantly predicts total male graduate enrollment (t(47) = 16.612, p < 0.001) with a strong positive correlation between the two variables (Pearson's r = 0.92).

```{r, include=FALSE}
# Run a single regression model on full time graduate male graduate students from 1967-2015

male_fulltimegrad_lm <- lm(grad_enrollment$males_full_time ~ grad_enrollment$year)

male_fulltimegrad_lm

# Graph full time male enrollment in US grad schools

grad_fulltimemale_lmgraph <- ggplot(grad_enrollment, aes(x = year, y = males_full_time)) +
geom_point() +
geom_smooth(method = lm, se = TRUE, size = 0.5, color = "dodgerblue") +
theme_bw() +
scale_x_continuous(expand = c(0,0), limits = c(1967, 2015)) +
labs(x = "Year", y = "Full Time Male Enrollment in U.S. Grad Schools")

grad_fulltimemale_lmgraph

# Run a single regression model on graduate full time female graduate students from 1967-2015.

female_fulltimegrad_lm <- lm(grad_enrollment$females_full_time ~ grad_enrollment$year)

female_fulltimegrad_lm

# Graph full time female enrollment in US grad schools

grad_fulltimefemale_lmgraph <- ggplot(grad_enrollment, aes(x = year, y = females_full_time)) +
geom_point() +
geom_smooth(method = lm, se = TRUE, size = 0.5, color = "dodgerblue") +
theme_bw() +
scale_x_continuous(expand = c(0,0), limits = c(1967, 2015)) +
labs(x = "Year", y = "Full Time Female Enrollment in U.S. Grad Schools")

grad_fulltimefemale_lmgraph

# Graph full time male and female enrollment together 

fulltimeenroll_graph <- ggplot(grad_enrollment, aes(x = year, y = males_full_time)) +
  geom_smooth(se = F, aes(col = "Male")) +
  geom_smooth(aes(x = year, y = females_full_time, col = "Female"), se = F) +
  labs(x = "Year", y = "Full Time Enrollment in U.S. Grad Schools")

fulltimeenroll_graph

```



```{r, include=FALSE}
# Run a single regression model on part time graduate male graduate students from 1967-2015

male_parttimegrad_lm <- lm(grad_enrollment$males_part_time ~ grad_enrollment$year)

male_parttimegrad_lm

# Graph part time male enrollment in US grad schools

grad_parttimemale_lmgraph <- ggplot(grad_enrollment, aes(x = year, y = males_part_time)) +
geom_point() +
geom_smooth(method = lm, se = TRUE, size = 0.5, color = "dodgerblue") +
theme_bw() +
scale_x_continuous(expand = c(0,0), limits = c(1967, 2015)) +
labs(x = "Year", y = "Part Time Male Enrollment in U.S. Grad Schools")

grad_fulltimemale_lmgraph

# Run a single regression model on graduate part time female graduate students from 1967-2015.

female_parttimegrad_lm <- lm(grad_enrollment$females_part_time ~ grad_enrollment$year)

female_parttimegrad_lm

# Graph part time female enrollment in US grad schools

grad_parttimefemale_lmgraph <- ggplot(grad_enrollment, aes(x = year, y = females_part_time)) +
geom_point() +
geom_smooth(method = lm, se = TRUE, size = 0.5, color = "dodgerblue") +
theme_bw() +
scale_x_continuous(expand = c(0,0), limits = c(1967, 2015)) +
labs(x = "Year", y = "Part Time Female Enrollment in U.S. Grad Schools")

grad_parttimefemale_lmgraph

# Graph part time male and female enrollment together 

parttimeenroll_graph <- ggplot(grad_enrollment, aes(x = year, y = females_part_time)) +
  geom_smooth(se = F, aes(col = "Female")) +
  geom_smooth(aes(x = year, y = males_part_time, col = "Male"), se = F) +
  labs(x = "Year", y = "Part Time Enrollment in U.S. Grad Schools")

parttimeenroll_graph
```

###2.) Shifts in female PhD recipients by field (1985, 2000, and 2015). Describe if and how there was a shift in PhDs awarded to females in four fields (Physical and Earth Sciences, Engineering, Education, and Humanities & Arts) in 1985, 2000, and 2015. Describe your results statistically, in a graph or table, and in text. Note: There are several ways that you can interpret this question. You are invited to decide which you think is/are most interesting. Just be really clear about what you are asking/answering in your report.

```{r, include=FALSE}
# create a df of female phds in the 4 fields in 1985, 2000, 2015

phd_shifts <- phds %>%
  select(physical_sciences_and_earth_sciences_female, engineering_female, education_female, humanities_and_arts_female)
  
phd_shifts

# create a proportion table

phds_prop <- prop.table(as.matrix(phd_shifts), 1)

phds_prop

# run a chi sq test

# We ask: "Is there a significant association between year (1985, 2000, and 2015) and female PhD recipients by field?"

female_phd_year_x2 <- chisq.test(phd_shifts)

female_phd_year_x2 

# graphically represent increase in female phds by field in 1985, 2000, and 2015

```

```{r, echo=FALSE}
# graphically represent increase in female phds by field in 1985, 2000, and 2015

phds_tbl3 <- phds_tbl2 %>% 
  select(field_of_study, "1985", "2000", "2015")

phds_femalecounts_year_tbl <- phds_tbl3 %>% 
  kable(col.names = c("Field of Study","1985", "2000", "2015"),caption = "Table 2. Number of Women PhDs in Four Fields in 1985, 2000, and 2015") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

phds_femalecounts_year_tbl
```




###3. Compare median salaries for male and female doctorate recipients in 2015. Answer these two questions:Does median salary differ significantly between male and female starting postdoc positions? Does median salary differ significantly between male and female PhD recipients in non-postdoc employment positions?

```{r}

# Create histograms to see if median salary data for employed and postdoc positions are normal

employmale_hist <- ggplot(med_salary_doctoral, aes(x = employment_male)) +
  geom_histogram()

employmale_hist

employfemale_hist <- ggplot(med_salary_doctoral, aes(x = employment_female)) +
  geom_histogram()

employfemale_hist

postdocmale_hist <- ggplot(med_salary_doctoral, aes(x = postdoc_male)) +
  geom_histogram() 

postdocmale_hist

postdocfemale_hist <- ggplot(med_salary_doctoral, aes(x = postdoc_female)) +
  geom_histogram() 

postdocfemale_hist

# Data is roughly normally distributed for employment median salary, but not normal for postdoc median salaries. We are going to use a non-parametric test since we want to compare medians, so we need to use a rank-based test. Tht test should be paired so that we are comparing males and females within their own fields. 

```

```{r}

# Run a Wilcoxon signed-rank test (paired) for males and females within their specific fields who are employed

# Null: The ranks are equal

# Alternative: The ranks are NOT equal

wsr_employ <- wilcox.test(med_salary_doctoral$employment_male, med_salary_doctoral$employment_female, paired = TRUE)

wsr_employ

# p value = 0.0026, less than 0.05, indicating that we reject the null hypothesis. The ranks are NOT equal. 

# Median salary differs significantly between male and female PhD recipients in non-postdoc employment positions based on 2005 median salary data.

# "Non-parametric Wilcoxon Signed-Rank for data collected from 10 locations around Santa Barbara county revealed that the median particulate matter concentration (µg/m3) did not increase significantly following the fire (V = 13.5, p = 0.08). While PM concentrations at 7 of the 10 sites were somewhat similar or even slightly decreased following the fire, there was a drastic spike in PM at the Santa Ynez station (from 19 to 284 µg/m3). Further analysis (e.g. of wind direction) is needed to understand the disproportionate increase at the Santa Ynez site.”

```


```{r}

# Calculate Cliff's Delta for Wilcoxon sign-rank test for  males and females within their specific fields who are employed

employ_cliffs <- cliff.delta(med_salary_doctoral$employment_male, med_salary_doctoral$employment_female)

employ_cliffs

# Small to medium effect size (Cliff's Delta = 0.21), meaning there is some overlap between groups

```
Employed in-line referencing: V = `r wsr_employ$statistic`, *p*  < 0.01, $\alpha$ = 0.05. Cliff's Delta = `r round(employ_cliffs$estimate,2)`.

```{r}

# Run a Wilcoxon signed-rank test (paired) for males and females within their specific fields who are postdocs

# Null: The ranks are equal

# Alternative: The ranks are NOT equal

wsr_postdoc <- wilcox.test(med_salary_doctoral$postdoc_male, med_salary_doctoral$postdoc_female, paired = TRUE)

wsr_postdoc

# p value = 0.888, which is greater than 0.05. Thus, we retain the null hypothesis. The ranks are equal.

# Median salary DOES NOT differ significantly between male and female PhD recipients starting postdoc positions based on 2005 median salary data. 

```

```{r}

# Calculate Cliff's Delta for Wilcoxon signed-rank test (paired) for males and females within their specific fields who are postdocs

postdoc_cliffs <- cliff.delta(med_salary_doctoral$postdoc_male, med_salary_doctoral$postdoc_female)

postdoc_cliffs

# Negligible effect size

```

###4. Explore relationships between variables in the ‘Faculty salary data (2008 - 2009 survey)’ dataset. Develop a model describing faculty salary based on data for faculty sex, rank, years in current position, field, and number of years since doctoral degree was earned. You should make decisions regarding which variables should remain in your final model. Describe the results qualitatively and quantitatively (i.e., don’t just report the statistical results of the model – make sure you describe interesting findings in text). You can also discuss any concerns that you have with the model(s) you present, if any.

```{r}

# First, look at the data graphically to determine if a linear relationship exists between faculty salary

salary_scatter <- ggplot(faculty_salary, aes(x = years_since_phd, y = salary)) +
  geom_point(aes(color = rank)) +
  facet_wrap(~ sex)

salary_scatter

# There seems to be a linear relationship between faculty salary and sex, ranks, and number of years since doctoral degree was earned

```


```{r}

# Create a mutivariate linear regression model for faculty salary

faculty_salary_lm <- lm(salary ~ sex + rank + years_since_phd + discipline, data = faculty_salary)

summary(faculty_salary_lm)

# Reference levels are females, associate professors, and discipline A. 

# salary = 78862.8 + 4783.5(sexmale) - 12907.6(rankAsstProf) + 32158.4(rankProf) + 535.1(years_since_phds) + 14417.6(disciplineB)

# If all other variables are the same, then male graduates with PhDs make $4,783.5 more than female graduates with PhDs.

# If all other variables are the same, then professors make $32,158.4 more than associate professors. 

# Adjusted R2 value is 0.45. 45% of the variance in faculty salaries can be predicted by the independent variable.

```

```{r}

# Check out model diagnostics

plot(faculty_salary_lm)

# Residuals are mostly linear, according to QQ plot, until you get to larger values. 

# Residuals vs. fitted shows scatter, but slight concentration around 0

```
### Note for Jess: Edit regression table caption 

```{r, results = 'asis'}

# Prepare a regression table

stargazer(faculty_salary_lm, 
          type = "html",
          align = TRUE,
          title = "*Table 2. Multivariate Linear Regression for Faculty Salaries in the US.* Results of the multivariate linear regression to examine faculty salaries in the US in comparison to sex, faculty rank, department type, and years since obtaining a PhD.",
          covariate.labels = c("Male (Sex)", "Assistant Professor (Rank)", "Professor (Rank)", "Years Since PhD", "Applied Department"),
          dep.var.labels=c("Salary"),
          single.row = TRUE
          )

# “Setosa sepal length significantly predicts sepal width (b = 0.79, t(48) = 7.6, p < 0.001) with a strong positive correlation between the two (Pearson’s r = 0.74). The overall model (width = 0.79(length) − 0.57; both in centimeters) explains a significant amount of variance in sepal width (F(1,48) = 59, p < 0.001, R2 = 0.55).”

```


