---
title: "assignment_5_jj_ab"
author: "Jessica Jagdeo and Alex Brown"
date: "December 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}

library(tidyverse)
library(stargazer)
library(effsize)
library(knitr)
library(kableExtra)
library(plotly)
library(pwr)
library(car)
library(RColorBrewer)
library(extrafont)
library(ggrepel)
library(effsize)
library(ggpubr)
library(vcdExtra)
library(dplyr)

faculty_salary <- read_csv("faculty_salary_data.csv")

grad_enrollment <- read_csv("grad_enrollment_2.csv")

med_salary_doctoral <- read_csv("median_salary_doctoral.csv")

phds <- read_csv("phds_updated_2.csv")

phds_tbl2 <- read_csv("phds_updated_4.csv")
```
###Introduction

The male-to-female ratio of students in college changed throughout the 20th century. Up until the 1930s, male and female undergraduate enrollment was about equal across colleges in the United States. After the 1930s, male enrollment began to increase at a faster rate than female enrollment because American soldiers were returning from overseas. During the period from the 1930s to the 1970s, colleges witnessed an increase in the male-to-female ratio of undergraduate students. However, this trajectory altered in the 1980s, with greater rates of female enrollment, and by 2003, there were 1.30 females for every male undergraduate. This pattern of increasing female enrollment can also be seen among graduate school enrollments, as female, as the academic year of 2016-2017 marked the eighth consecutive year in which females earned more doctoral degrees than males.

Although college enrollments are greater for American females than for males, college-educated women are still not paid equally compared to college-educated men with similar skills and backgrounds. In addition, further categorizations using racial groups better depict wage gaps among college-educated males and females. A study conducted in 1998 discovered that there is a ten to fifteen percent wage difference between white women, black men, black women, Asian men, and Asian women in comparison to white men who have the same characteristics and qualities of college education. Furthermore, this inequality in wages occurs among males and females with graduate degrees. A 2015 study determined that female science and engineering doctoral recipients report having lower salaries than their male colleagues. 

Many studies have been conducted to analyze undergraduate enrollment and wage gaps for college-educated people based on gender. However, studies that specifically examine male and female graduate students in these areas are more elusive. Thus, this study seeks to add to the existing literature regarding graduate students by investigating male and female graduate school enrollment from 1967 to 2015. Furthermore, this paper aims to identify shifts in female PhD recipients by field at three different periods in history. Lastly, this study will analyze patterns between salary and gender by examining median salaries for male and female doctoral recipients in 2015 and academic salaries for professors in American colleges. 

###Data and Methods

The graduate enrollment data used in this study was provided by the US Department of Education’s National Center for Education Statistics Higher Education General Information Survey. Information on doctoral recipients and their median salaries were obtained from the National Science Foundation’s National Center for Science and Engineering Statistics Survey of Earned Doctorates. In addition, Fox J. and Weisberg, S. (2011) An R Companion to Applied Regression, Second Edition Sage provided data on professor characteristics and associated salaries, gathered from surveys.

The data used in this study was analyzed in R. Two separate linear regressions were created to examine changes in female and male graduate enrollment between 1967 and 2015. To analyze changes in female PhD recipients by field in 1985, 2000, and 2015, a chi-square test was conducted. A paired Wilcoxon sign-rank test was used to compare the median salaries of male and female doctorate recipients within the same field who are currently employed as postdoctoral researchers. In addition, another paired Wilcoxon sign-rank test compared the median salaries of male and female doctorate recipients within the same field, but examined only those employed outside of postdoctoral research. Lastly, a multivariate linear regression model was created to analyze university faculty salaries in the U.S. based on gender, faculty rank, field,  the number of years since obtaining a PhD, and the number of years as a faculty member. 

###Results and Discussion

####A Comparison of Male and Female Graduate Enrollment From 1967 to 2015

The total number of both male and female graduate students enrolled in U.S. institutions of higher education grew rapidly between 1967 and 2015, according to data from the US Department of Education. However, the rate at which female graduate student enrollment increased compared to their male counterparts was far greater during this period. In 1967 there were approximately 38 thousand more male graduate students enrolled in U.S. colleges than female enrolled graduate students, but by 1988 female graduate students outnumbered their male counterparts. In 2015, the last year of recorded data, graduate enrolled females outnumbered males by nearly 50 thousand in U.S. colleges and universities.

```{r, include=FALSE}
# Run a single regression model on graduate male graduate students from 1967-2015

male_grad_lm <- lm(grad_enrollment$total_males ~ grad_enrollment$year)

male_grad_lm

# Run Pearson's r

male_grad_pearson <- cor.test(grad_enrollment$year, grad_enrollment$total_males)

male_grad_pearson
# Run a single regression model on graduate female graduate students from 1967-2015.

female_grad_lm <- lm(grad_enrollment$total_females ~ grad_enrollment$year) 

female_grad_lm

female_grad_pearson <- cor.test(grad_enrollment$year, grad_enrollment$total_females)

female_grad_pearson


```

```{r, echo=FALSE}
# # Graph male and female enrollment together 

enroll_graph <- ggplot(grad_enrollment, aes(x = year, y = total_males)) +
  geom_line(aes(color = "total_males")) +
  geom_smooth(method = lm, se = F, aes(col = "Male Linear\n Regression\n")) +
  geom_smooth(aes(x = year, y = total_females, col = "Female Linear\n Regression\n"), method = lm, se = F) +
  geom_line(aes(x = year, y = total_females, color = "total_females")) +
  labs(x = "Year", y = "Total Enrollment") + 
  labs(color='Sex') +
  theme_classic() +
  scale_color_hue(labels = c("Female Linear\n Regression\n", "Male Linear\n Regression\n", "Total Females", "Total Males")) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

enroll_graph
```

**Figure 1. Relationship between total female graduate enrolled students and year (1967-2015) and total male graduate enrolled students and year (1967-2015).** Year significantly predicts total female graduate enrollment (t(47) = 51.659, *p* < 0.001) with a strong positive correlation between the two variables (Pearson’s r = 0.99). Year also significantly predicts total male graduate enrollment (t(47) = 16.612, p < 0.001) with a strong positive correlation between the two variables (Pearson's r = 0.92).

To determine whether there was an association between year and and number of enrolled male graduate students, a single variable linear regression model was run with ‘year’ being the independent variable and ‘total enrolled male graduate students’ being the dependent variable. The year significantly predicts total male graduate enrollment (t(47) = 16.612, *p* < 0.001) with a strong positive correlation between the two variables (Pearson's r = 0.92). (Figure 1). To determine whether there was an association between year and and number of enrolled female graduate students, another single variable linear regression model was run with ‘year’ being the independent variable and ‘total enrolled female graduate students’ being the dependent variable. In this case, year also significantly predicts total female graduate enrollment (t(47) = 51.659, *p* < 0.001) with a strong positive correlation between the two variables (Pearson’s r = 0.99). (Figure 1). 

While there is an association between both the number of male and female graduate enrolled students and the year, it is important to note some key differences between the two. The proportion of female graduate students enrolled part time is far higher in comparison to the proportion of female graduate students enrolled full time. Part time female graduate students surpassed part time male graduate students in the mid 1970s, whereas full time female graduate students surpassed the number of full time male graduate students in the late 1990s.

The slower growth of full time female graduate students in comparison to part time female enrolled graduate students can potentially be explained due to differences in gender roles in the 1970s and 1980s. During this time it was still common place for women to be the primary caregiver for their family, while men were the primary source of income. Beginning in the 1990s, the number of full time female graduate students increased rapidly, perhaps as a result of the changing societal views on gender roles. 

```{r, include=FALSE}
# create a df of female phds in the 4 fields in 1985, 2000, 2015

phd_shifts <- phds %>%
  select(physical_sciences_and_earth_sciences_female, engineering_female, education_female, humanities_and_arts_female)
  
phd_shifts

# create a proportion table

phds_prop <- prop.table(as.matrix(phd_shifts), 1)

phds_prop

# run a chi sq test

# We ask: "Is there a significant association between year (1985, 2000, and 2015) and female PhD recipients by field?"

female_phd_year_x2 <- chisq.test(phd_shifts)

female_phd_year_x2 

# graphically represent increase in female phds by field in 1985, 2000, and 2015

```
####Changes in Female PhD recipients in Four Fields in 1985, 2000, and 2015

The number of female PhD recipients in physical and earth sciences, engineering, education, and humanities and the arts increased from 1985 to 2015. The amount of increase in female PhD recipients was substantial in physical and earth sciences, engineering, and humanities and the arts, however the increase in education was rather nominal.
```{r, echo=FALSE}
# graphically represent increase in female phds by field in 1985, 2000, and 2015

phds_tbl3 <- phds_tbl2 %>% 
  select(field_of_study, "1985", "2000", "2015")

phds_femalecounts_year_tbl <- phds_tbl3 %>% 
  kable(col.names = c("Field of Study","1985", "2000", "2015"),caption = "Table 2. Number of Women PhDs in Four Fields in 1985, 2000, and 2015") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

phds_femalecounts_year_tbl
```
In order to determine if a significant association exists between female PhD recipients by field and year, we complied the raw counts of female PhD recipients by field and the year in which they were recorded (1985, 2000, 2015). (See Table 2). After the raw counts were compiled we converted the raw counts into proportions in order to run a Pearson’s chi-square test for association between year and the number of female PhD recipients by field. After running the test an association between year and female PhD recipients by field was found, $\chi^2$(6) = 2073.3, *p* < 0.001.

The most interesting aspect in this data is the amount of increase in female PhD recipients in STEM fields (physical/earth sciences, engineering). The amount of female PhD recipients in physical and earth sciences increased nearly 350 % between 1985 and 2015, whereas the amount of female PhD recipients in engineering increased by over 1000%. The amount of female PhD recipients in humanities and arts doubled, however the amount of female PhD recipients in education barely increased from 1985 to 2015 by just 11 more recipients. In fact, the amount of female PhD recipients in education decreased from its peak in 2000 of 4,179 to 3,502 in 2015. (Table 2).

The large increases in female PhD recipients in STEM fields can also potentially be explained in shifting societal notions of what is considered “so-called” male or female professions. In the 1980s it was still a popular notion in American society that “female professions” did not usually include professions such as a scientist or an engineer. However, as these notions have shifted significantly over the past several decades the number of female PhD recipients in STEM have increased dramatically. 




###3. Compare median salaries for male and female doctorate recipients in 2015. Answer these two questions:Does median salary differ significantly between male and female starting postdoc positions? Does median salary differ significantly between male and female PhD recipients in non-postdoc employment positions?

```{r}

# Create histograms to see if median salary data for employed and postdoc positions are normal

employmale_hist <- ggplot(med_salary_doctoral, aes(x = employment_male)) +
  geom_histogram()

employmale_hist

employfemale_hist <- ggplot(med_salary_doctoral, aes(x = employment_female)) +
  geom_histogram()

employfemale_hist

postdocmale_hist <- ggplot(med_salary_doctoral, aes(x = postdoc_male)) +
  geom_histogram() 

postdocmale_hist

postdocfemale_hist <- ggplot(med_salary_doctoral, aes(x = postdoc_female)) +
  geom_histogram() 

postdocfemale_hist

# Data is roughly normally distributed for employment median salary, but not normal for postdoc median salaries. We are going to use a non-parametric test since we want to compare medians, so we need to use a rank-based test. Tht test should be paired so that we are comparing males and females within their own fields. 

```

```{r}

# Run a Wilcoxon signed-rank test (paired) for males and females within their specific fields who are employed

# Null: The ranks are equal

# Alternative: The ranks are NOT equal

wsr_employ <- wilcox.test(med_salary_doctoral$employment_male, med_salary_doctoral$employment_female, paired = TRUE)

wsr_employ

# p value = 0.0026, less than 0.05, indicating that we reject the null hypothesis. The ranks are NOT equal. 

# Median salary differs significantly between male and female PhD recipients in non-postdoc employment positions based on 2005 median salary data.

# "Non-parametric Wilcoxon Signed-Rank for data collected from 10 locations around Santa Barbara county revealed that the median particulate matter concentration (µg/m3) did not increase significantly following the fire (V = 13.5, p = 0.08). While PM concentrations at 7 of the 10 sites were somewhat similar or even slightly decreased following the fire, there was a drastic spike in PM at the Santa Ynez station (from 19 to 284 µg/m3). Further analysis (e.g. of wind direction) is needed to understand the disproportionate increase at the Santa Ynez site.”

```


```{r}

# Calculate Cliff's Delta for Wilcoxon sign-rank test for  males and females within their specific fields who are employed

employ_cliffs <- cliff.delta(med_salary_doctoral$employment_male, med_salary_doctoral$employment_female)

employ_cliffs

# Small to medium effect size (Cliff's Delta = 0.21), meaning there is some overlap between groups

```
Employed in-line referencing: V = `r wsr_employ$statistic`, *p*  < 0.01, $\alpha$ = 0.05. Cliff's Delta = `r round(employ_cliffs$estimate,2)`.

```{r}

# Run a Wilcoxon signed-rank test (paired) for males and females within their specific fields who are postdocs

# Null: The ranks are equal

# Alternative: The ranks are NOT equal

wsr_postdoc <- wilcox.test(med_salary_doctoral$postdoc_male, med_salary_doctoral$postdoc_female, paired = TRUE)

wsr_postdoc

# p value = 0.888, which is greater than 0.05. Thus, we retain the null hypothesis. The ranks are equal.

# Median salary DOES NOT differ significantly between male and female PhD recipients starting postdoc positions based on 2005 median salary data. 

```

```{r}

# Calculate Cliff's Delta for Wilcoxon signed-rank test (paired) for males and females within their specific fields who are postdocs

postdoc_cliffs <- cliff.delta(med_salary_doctoral$postdoc_male, med_salary_doctoral$postdoc_female)

postdoc_cliffs

# Negligible effect size

```

###4. Explore relationships between variables in the ‘Faculty salary data (2008 - 2009 survey)’ dataset. Develop a model describing faculty salary based on data for faculty sex, rank, years in current position, field, and number of years since doctoral degree was earned. You should make decisions regarding which variables should remain in your final model. Describe the results qualitatively and quantitatively (i.e., don’t just report the statistical results of the model – make sure you describe interesting findings in text). You can also discuss any concerns that you have with the model(s) you present, if any.

```{r}

# First, look at the data graphically to determine if a linear relationship exists between faculty salary

salary_scatter <- ggplot(faculty_salary, aes(x = years_since_phd, y = salary)) +
  geom_point(aes(color = rank)) +
  facet_wrap(~ sex)

salary_scatter

# There seems to be a linear relationship between faculty salary and sex, ranks, and number of years since doctoral degree was earned

```


```{r}

# Create a mutivariate linear regression model for faculty salary

faculty_salary_lm <- lm(salary ~ sex + rank + years_since_phd + discipline, data = faculty_salary)

summary(faculty_salary_lm)

# Reference levels are females, associate professors, and discipline A. 

# salary = 78862.8 + 4783.5(sexmale) - 12907.6(rankAsstProf) + 32158.4(rankProf) + 535.1(years_since_phds) + 14417.6(disciplineB)

# If all other variables are the same, then male graduates with PhDs make $4,783.5 more than female graduates with PhDs.

# If all other variables are the same, then professors make $32,158.4 more than associate professors. 

# Adjusted R2 value is 0.45. 45% of the variance in faculty salaries can be predicted by the independent variable.

```

```{r}

# Check out model diagnostics

plot(faculty_salary_lm)

# Residuals are mostly linear, according to QQ plot, until you get to larger values. 

# Residuals vs. fitted shows scatter, but slight concentration around 0

```
### Note for Jess: Edit regression table caption 

```{r, results = 'asis'}

# Prepare a regression table

stargazer(faculty_salary_lm, 
          type = "html",
          align = TRUE,
          title = "*Table 2. Multivariate Linear Regression for Faculty Salaries in the US.* Results of the multivariate linear regression to examine faculty salaries in the US in comparison to sex, faculty rank, department type, and years since obtaining a PhD.",
          covariate.labels = c("Male (Sex)", "Assistant Professor (Rank)", "Professor (Rank)", "Years Since PhD", "Applied Department"),
          dep.var.labels=c("Salary"),
          single.row = TRUE
          )

# “Setosa sepal length significantly predicts sepal width (b = 0.79, t(48) = 7.6, p < 0.001) with a strong positive correlation between the two (Pearson’s r = 0.74). The overall model (width = 0.79(length) − 0.57; both in centimeters) explains a significant amount of variance in sepal width (F(1,48) = 59, p < 0.001, R2 = 0.55).”

```


